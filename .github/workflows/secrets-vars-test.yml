name: Secrets + Vars Multi-Env Test

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'é¸æ“‡ç’°å¢ƒ'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - production

jobs:
  test-vars:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}  # æ‰‹å‹•é¸ dev/staging/prod
    
    steps:
    - uses: actions/checkout@v4

    - name: ðŸ”§ Fix permissions
      run: chmod +x test-script.sh

    - name: ðŸª„ Inject ALL variables to env
      env:
        # Secretsï¼ˆæ©Ÿå¯†ï¼‰
        APP_SECRET: ${{ secrets.APP_SECRET }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        # Repository / Environment Variablesï¼ˆéžæ©Ÿå¯†ï¼‰
        APP_ENV: ${{ vars.APP_ENV }}
        REGISTRY_URL: ${{ vars.REGISTRY_URL }}
        BUILD_VERSION: ${{ vars.BUILD_VERSION }}
        DEBUG_MODE: ${{ vars.DEBUG_MODE }}
      run: |
        echo "=== Workflow sees vars ==="
        echo "APP_ENV=${{ vars.APP_ENV }}"
        echo "DEBUG_MODE=${{ vars.DEBUG_MODE }}"
        
        # å»ºç«‹ .env æª”æ¡ˆï¼ˆæ¨¡æ“¬å¯¦éš›å°ˆæ¡ˆéœ€æ±‚ï¼‰
        echo "APP_SECRET=$APP_SECRET" >> .env
        echo "DB_PASSWORD=$DB_PASSWORD" >> .env
        echo "APP_ENV=$APP_ENV" >> .env
        echo "REGISTRY_URL=$REGISTRY_URL" >> .env
        echo "BUILD_VERSION=$BUILD_VERSION" >> .env
        echo "DEBUG_MODE=$DEBUG_MODE" >> .env
        
        echo "=== Generated .env content (Secrets hidden) ==="
        cat .env

    - name: ðŸš€ Docker Composeï¼ˆå…¨è®Šæ•¸æ³¨å…¥ï¼‰
      env:
        APP_SECRET: ${{ secrets.APP_SECRET }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        APP_ENV: ${{ vars.APP_ENV }}
        REGISTRY_URL: ${{ vars.REGISTRY_URL }}
        BUILD_VERSION: ${{ vars.BUILD_VERSION }}
        DEBUG_MODE: ${{ vars.DEBUG_MODE }}
      run: |
        docker compose up test-app
        docker compose down
