name: Secrets + Vars Multi-Env Test

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'é¸æ“‡ç’°å¢ƒ'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - production

jobs:
  test-vars:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}  # æ‰‹å‹•é¸ dev/staging/prod
    
    steps:
    - uses: actions/checkout@v4

    - name: ğŸ”§ Fix permissions
      run: chmod +x test-script.sh

    - name: ğŸª„ Inject ALL variables to env
      env:
        # Secretsï¼ˆæ©Ÿå¯†ï¼‰
        APP_SECRET: ${{ secrets.APP_SECRET }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        # Repository / Environment Variablesï¼ˆéæ©Ÿå¯†ï¼‰
        APP_ENV: ${{ vars.APP_ENV }}
        REGISTRY_URL: ${{ vars.REGISTRY_URL }}
        BUILD_VERSION: ${{ vars.BUILD_VERSION }}
        DEBUG_MODE: ${{ vars.DEBUG_MODE }}
      run: |
        echo "=== Workflow sees vars ==="
        echo "APP_ENV=${{ vars.APP_ENV }}"
        echo "DEBUG_MODE=${{ vars.DEBUG_MODE }}"
        
        # å»ºç«‹ .env æª”æ¡ˆï¼ˆæ¨¡æ“¬å¯¦éš›å°ˆæ¡ˆéœ€æ±‚ï¼‰
        echo "APP_SECRET=$APP_SECRET" >> .env
        echo "DB_PASSWORD=$DB_PASSWORD" >> .env
        echo "APP_ENV=$APP_ENV" >> .env
        echo "REGISTRY_URL=$REGISTRY_URL" >> .env
        echo "BUILD_VERSION=$BUILD_VERSION" >> .env
        echo "DEBUG_MODE=$DEBUG_MODE" >> .env
        
        echo "=== Generated .env content (Secrets hidden) ==="
        cat .env

    - name: ğŸ” Debug Secrets (B64 Encoded)
      run: |
        # ä½¿ç”¨ Base64 ç·¨ç¢¼è¼¸å‡ºä»¥ç¹é GitHub Actions çš„è‡ªå‹•é®è”½ (***)
        # è¤‡è£½è¼¸å‡ºå­—ä¸²å¾Œï¼Œå¯ä½¿ç”¨ 'echo "å­—ä¸²" | base64 --decode' é€²è¡Œé©—è­‰
        echo "=== è¤‡è£½ä»¥ä¸‹å­—ä¸²é€²è¡Œ Base64 è§£ç¢¼é©—è­‰ ==="
        echo "TEST_SERVER_DB_PWD: $(echo ${{ secrets.TEST_SERVER_DB_PWD }} | base64)"
        echo "REDIS_PASSWORD: $(echo ${{ secrets.REDIS_PASSWORD }} | base64)"
        echo "GRAFANA_TOKEN: $(echo ${{ secrets.GRAFANA_TOKEN }} | base64)"
        echo "TELEGRAM_BOT_TOKEN: $(echo ${{ secrets.TELEGRAM_BOT_TOKEN }} | base64)"

    - name: ğŸš€ Docker Composeï¼ˆå…¨è®Šæ•¸æ³¨å…¥ï¼‰
      env:
        APP_SECRET: ${{ secrets.APP_SECRET }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        APP_ENV: ${{ vars.APP_ENV }}
        REGISTRY_URL: ${{ vars.REGISTRY_URL }}
        BUILD_VERSION: ${{ vars.BUILD_VERSION }}
        DEBUG_MODE: ${{ vars.DEBUG_MODE }}
      run: |
        docker compose up test-app
        docker compose down
